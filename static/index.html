<!DOCTYPE html>
<html>
<head>
    <title>Go WebSocket Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .chat { border: 1px solid #ccc; height: 100px; overflow-y: scroll; padding: 10px; margin-bottom: 3px; margin-top: 15px; }
        .users { border: 1px solid #ccc; height: 100px; overflow-y: scroll; padding: 10px; margin-bottom: 3px; margin-top: 15px; }
        .versions { border: 1px solid #ccc; height: 100px; overflow-y: scroll; padding: 10px; margin-bottom: 3px; margin-top: 15px; }
        .message { margin-bottom: 10px; }
        .username { font-weight: bold; color: #3366cc; }
        .time { color: #999; font-size: 0.8em; }
    </style>
</head>
<body>
    <h1>WebSocket Chat на Go</h1>
    
    <div style="border: 10px;">
        Добавить человека в чат:
        <input type="text" id="new_chat_id" placeholder="ID чата (оставьте пустым, чтобы создать новый чат)" style="width: 150px;">
        <input type="text" id= "new_chat_uid" placeholder="ID человека">
        <!-- <input type="file" -->
        <button id="new_chat_button" onclick="sendAddChat()">Добавить</button>
    </div>
    
    
    <div id="my_uid"></div>

    <textarea id="coedit"></textarea>
    <div>
        <input type="text" id="coedit_version_name" placeholder="Название версии" style="width: 150px;">
        <button onclick="saveCoedit()">
            Сохранить версию
        </button>
        <div id="coedit_versions" class="versions"></div>
    </div>

    <div id="chats">
    </div>

    <script>
        chats_map = {};
        chats_users_map = {};

        const chats = document.getElementById('chats');
        // const messageInput = document.getElementById('message');

        // var my_username = prompt("Введите своё имя:", "Гость");
        var my_username = ""; // TODO: убрать вообще? лучше передавать его вместе с my_uid
        var my_uid = -1;

        addChat(-1, false);

        
        // Подключаемся к WebSocket серверу
        const ws = new WebSocket('ws://localhost:8080/ws/');

        coedit_info = {
            id: -1,
            version: -1,
        }
        coedit = document.getElementById("coedit");
        coedit.addEventListener("input", function(event) {
            content = event.target.value;
            ws.send(JSON.stringify({
                event_type: "sync_coedit",
                sender: my_uid,
                data: JSON.stringify({
                    coedit_id: coedit_info.id,
                    version: coedit_info.version,
                    content: content,
                })
            }));
        });
        
        ws.onopen = function() {
            addMessage(-1, 'Система', 'Подключено к серверу');
        };
        
        ws.onclose = function() {
            addMessage(-1, 'Система', 'Соединение закрыто');
        };
        
        ws.onmessage = function(event) {
            event = JSON.parse(event.data);
            // alert(event.event_type + " " + event.data);
            // Заменить на switch
            if (event.event_type == "message") {
                const msg = JSON.parse(event.data);
                if (msg.coedit_info.is_coedit) {
                    addCoedit(msg.chat_id, msg.coedit_info.coedit_id, msg.sender.username)
                }
                else if (msg.filename != "") {
                    addFile(msg.chat_id, msg.sender.username, msg.filename);
                }
                else {
                    addMessage(msg.chat_id, msg.sender.username, msg.message);
                }
            }
            else if (event.event_type == "uid") {
                my_uid = JSON.parse(event.data);
                document.getElementById('my_uid').innerText = "Ваш ID: " + my_uid;
            }
            else if (event.event_type == "invitation") {
                const chat_id = parseInt(event.data);
                addChat(chat_id);
            }
            else if (event.event_type == "file") {
                const a = document.createElement('a');
                data = JSON.parse(event.data);
                a.href = data.content;
                a.download = data.filename;
                a.click();
            }
            else if (event.event_type == "addition") {
                data = JSON.parse(event.data);
                addUser(data.chat_id, data.user_id, data.username, data.rights_level);
            }
            else if (event.event_type == "toggle_user_info") {
                data = JSON.parse(event.data);
                users_element = chats.children[chats_map[data.chat_id]].children[1];

                if (data.is_admin) {
                    rights_level_now = chats_users_map[data.chat_id][data.user_id].rights_level;
                    chats_users_map[data.chat_id][data.user_id].rights_level = 1 - rights_level_now;
                    
                    if (rights_level_now == 1) {
                        users_element.children[chats_users_map[data.chat_id][data.user_id].position].children[0].innerText = "";
                    }
                    else {
                        users_element.children[chats_users_map[data.chat_id][data.user_id].position].children[0].innerText = "(Admin)";
                    }
                }

                if (data.is_muted) {
                    is_muted_now = chats_users_map[data.chat_id][data.user_id].is_muted;
                    chats_users_map[data.chat_id][data.user_id].is_muted = !is_muted_now;
                    
                    if (is_muted_now) {
                        users_element.children[chats_users_map[data.chat_id][data.user_id].position].children[1].innerText = "";
                    }
                    else {
                        users_element.children[chats_users_map[data.chat_id][data.user_id].position].children[1].innerText = "(Muted)";
                    }
                }

                if (data.is_kicked) {                    
                    // FIXME: perform the actual deletion
                    users_element.children[chats_users_map[data.chat_id][data.user_id].position].innerHTML = "";

                    // FIXME: perform the actual deletion
                    if (data.user_id == my_uid) {
                        chats.children[chats_map[data.chat_id]].innerHTML = "";
                    }
                }
            }
            else if (event.event_type == "sync_coedit") {
                data = JSON.parse(event.data);
                if (coedit_info.id == data.coedit_id) {
                    coedit.value = data.version.content;
                    coedit_info.version = data.version.version;
                    coedit_versions_element = document.getElementById("coedit_versions");
                    coedit_versions_element.innerHTML = "";
                    for (const version of data.versions) {
                        version_element = document.createElement("div");
                        version_element.innerText = version.number + ", " + version.name + ": ";
                        revert_element = document.createElement("button");
                        revert_element.innerText = "Загрузить";
                        revert_element.onclick = () => {
                            ws.send(JSON.stringify({
                                event_type: "revert_coedit",
                                sender: my_uid,
                                data: JSON.stringify({
                                    coedit_id: data.coedit_id,
                                    version: version.number,
                                })
                            }));
                        };
                        version_element.appendChild(revert_element);

                        coedit_versions_element.appendChild(version_element);
                        coedit_versions_element.scrollTop = coedit_versions_element.scrollHeight;
                    }
                }
            }
        };
        
        function sendMessage(chat_id, messageInput, fileInput) {
            const message = messageInput.value;
            const flies = fileInput.flies;
            
            if (message) {
                ws.send(JSON.stringify({
                    event_type: "message",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        message: message,
                        sender: {
                            uid: my_uid,
                            username: my_username,
                        },
                        chat_id: chat_id,
                        filename: "",
                    })
                }));
                messageInput.value = '';
            }

            for (const file of fileInput.files) {
                let name = file.name;

                let reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onload = function() {
                    console.log(reader.result);
                    ws.send(JSON.stringify({
                        event_type: "message",
                        sender_uid: my_uid,
                        data: JSON.stringify({
                            message: reader.result,
                            sender: {
                                uid: my_uid,
                                username: my_username,
                            },
                            chat_id: chat_id,
                            filename: name,
                        })
                    }));
                };

                reader.onerror = function() {
                    console.log(reader.error);
                };
            }

            if (fileInput.files.length) {
                fileInput.value = '';
            }
        }

        function addChat(chat_id, can_send_messages=true) {
            const chat_index = Object.keys(chats_map).length;
            chats_map[chat_id] = chat_index;
            chats_users_map[chat_id] = {};
            chats.appendChild(document.createElement('div'));

            const chatElement = document.createElement('div');
            chatElement.className = 'chat';
            chats.lastElementChild.appendChild(chatElement);

            const usersElement = document.createElement('div');
            usersElement.className = 'users';
            chats.lastElementChild.appendChild(usersElement);

            const chatIdElement = document.createElement('div');
            chatIdElement.innerText = "ID чата: " + chat_id;
            chats.lastElementChild.appendChild(chatIdElement);

            if (!can_send_messages) return;

            const inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.style ='width: 300px;';
            inputElement.placeholder = 'Сообщение';
            
            

            const fileElement = document.createElement('input');
            fileElement.type = 'file';
            fileElement.style ='width: 100px;';
            fileElement.placeholder = 'Файл';
            // Отправка по Enter
            inputElement.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage(chat_id, inputElement, fileElement);
                }
            });
            // Отправка по Enter
            fileElement.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage(chat_id, inputElement, fileElement);
                }
            });
            chats.lastElementChild.appendChild(inputElement);
            chats.lastElementChild.appendChild(fileElement);

            const buttonElement = document.createElement('button');
            buttonElement.innerText = 'Отправить';
            buttonElement.onclick = () => sendMessage(chat_id, chats.lastElementChild.lastElementChild,
                chats.lastElementChild.children[chats.lastElementChild.children.length - 2]
            ); // Сомнительный момент
            chats.lastElementChild.appendChild(buttonElement);

            const coeditElement = document.createElement('button');
            coeditElement.innerText = 'Создать документ для совместного редактирования';
            coeditElement.onclick = () => ws.send(JSON.stringify({
                    event_type: "add_coedit",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        chat_id: chat_id
                    })
                }));
            chats.lastElementChild.appendChild(coeditElement);
        }

        function addUser(chat_id, user_id, username, rights_level) {
            chats_users_map[chat_id][user_id] = {
                "username": username,
                "rights_level": rights_level,
                "is_muted": false,
                "position": Object.keys(chats_users_map[chat_id]).length,
            };

            const userElement = document.createElement('div');
            userElement.innerText = "" + user_id + ": " + username;

            const isAdmin = document.createElement('div');
            if (rights_level == 1) isAdmin.innerText = '(Admin)';
            else if (rights_level == 2) isAdmin.innerText = "(Group owner)";
            userElement.appendChild(isAdmin);

            const isMuted = document.createElement('div');
            userElement.appendChild(isMuted);
            
            kickButton = document.createElement('button');
            muteButton = document.createElement('button');
            addAdminButton = document.createElement('button');

            kickButton.innerText = '👟';
            muteButton.innerText = '🔇';
            addAdminButton.innerText = '👑';

            kickButton.onclick = () => {
                ws.send(JSON.stringify({
                    event_type: "toggle_user_info",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        user_id: user_id,
                        chat_id: chat_id,
                        is_admin: false,
                        is_muted: false,
                        is_kicked: true,
                    })
                }));
            }

            muteButton.onclick = () => {
                ws.send(JSON.stringify({
                    event_type: "toggle_user_info",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        user_id: user_id,
                        chat_id: chat_id,
                        is_admin: false,
                        is_muted: true,
                        is_kicked: false,
                    })
                }));
            }

            addAdminButton.onclick = () => {
                ws.send(JSON.stringify({
                    event_type: "toggle_user_info",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        user_id: user_id,
                        chat_id: chat_id,
                        is_admin: true,
                        is_muted: false,
                        is_kicked: false,
                    })
                }));
            }

            userElement.appendChild(kickButton);
            userElement.appendChild(muteButton);
            userElement.appendChild(addAdminButton);

            let usersElement = chats.children[chats_map[chat_id]].children[1];
            usersElement.appendChild(userElement);
            usersElement.scrollTop = usersElement.scrollHeight;
        }
        
        function addMessage(chat_id, username, message, time = new Date().toLocaleTimeString()) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
                <span class="username">${username}:</span>
                ${message}
            `;
            let chat = chats.children[chats_map[chat_id]].children[0];
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }

        function sendAddChat() {
            const chatIdElement = document.getElementById("new_chat_id");
            const chatUidElement = document.getElementById("new_chat_uid");

            new_chat_id = chatIdElement.value;
            if (new_chat_id == "") new_chat_id = "-1";
            new_chat_uid = chatUidElement.value;

            ws.send(JSON.stringify({
                event_type: "invitation",
                sender_uid: my_uid,
                data: JSON.stringify({
                    chat_id: parseInt(new_chat_id),
                    user_id: parseInt(new_chat_uid),
                }),
            }));

            chatIdElement.value = "";
            chatUidElement.value = "";
        }

        function addFile(chat_id, username, filename) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
                <span class="username">${username}:</span>
            `;
            const buttonElement = document.createElement('button');
            buttonElement.innerText = filename;
            buttonElement.onclick = () => {
                ws.send(JSON.stringify({
                    event_type: "file",
                    sender_uid: my_uid,
                    data: filename,
                }));
            }
            messageElement.appendChild(buttonElement);
            let chat = chats.children[chats_map[chat_id]].children[0];
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }

        function addCoedit(chat_id, coedit_id, username) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
                <span class="username">${username}:</span>
            `;
            const buttonElement = document.createElement('button');
            buttonElement.innerText = "Совместное редактирование";
            buttonElement.onclick = () => {
                coedit_info.id = coedit_id;
                ws.send(JSON.stringify({
                    event_type: "sync_coedit",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        coedit_id: coedit_id,
                        version: -1,
                        content: "",
                    }),
                }));
            }
            messageElement.appendChild(buttonElement);
            let chat = chats.children[chats_map[chat_id]].children[0];
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }

        document.getElementById("new_chat_uid").addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAddChat();
            }
        });

        document.getElementById("new_chat_id").addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAddChat();
            }
        });

        function saveCoedit() {
            nameElement = document.getElementById("coedit_version_name");
            name = nameElement.value;
            nameElement.value = "";
            if (name == "") {
                name = "Unnamed save";
            }

            ws.send(JSON.stringify({
                event_type: "save_coedit",
                sender: my_uid,
                data: JSON.stringify({
                    coedit_id: coedit_info.id,
                    name: name,
                })
            }))
        }
    </script>
</body>
</html>