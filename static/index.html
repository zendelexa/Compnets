<!DOCTYPE html>
<html>
<head>
    <title>Go WebSocket Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .chat { border: 1px solid #ccc; height: 100px; overflow-y: scroll; padding: 10px; margin-bottom: 3px; margin-top: 15px; }
        .users { border: 1px solid #ccc; height: 100px; overflow-y: scroll; padding: 10px; margin-bottom: 3px; margin-top: 15px; }
        .message { margin-bottom: 10px; }
        .username { font-weight: bold; color: #3366cc; }
        .time { color: #999; font-size: 0.8em; }
    </style>
</head>
<body>
    <h1>WebSocket Chat Ð½Ð° Go</h1>
    
    <div style="border: 10px;">
        Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ° Ð² Ñ‡Ð°Ñ‚:
        <input type="text" id="new_chat_id" placeholder="ID Ñ‡Ð°Ñ‚Ð° (Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‡Ð°Ñ‚)" style="width: 150px;">
        <input type="text" id= "new_chat_uid" placeholder="ID Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°">
        <!-- <input type="file" -->
        <button id="new_chat_button" onclick="sendAddChat()">Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ</button>
    </div>
    
    
    <div id="my_uid"></div>

    <div id="chats">
    </div>

    <script>
        chats_map = {};
        chats_users_map = {};

        const chats = document.getElementById('chats');
        // const messageInput = document.getElementById('message');

        // var my_username = prompt("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ñ‘ Ð¸Ð¼Ñ:", "Ð“Ð¾ÑÑ‚ÑŒ");
        var my_username = ""; // TODO: ÑƒÐ±Ñ€Ð°Ñ‚ÑŒ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ? Ð»ÑƒÑ‡ÑˆÐµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾ Ð²Ð¼ÐµÑÑ‚Ðµ Ñ my_uid
        var my_uid = -1;

        addChat(-1, false);

        
        // ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº WebSocket ÑÐµÑ€Ð²ÐµÑ€Ñƒ
        const ws = new WebSocket('ws://localhost:8080/ws/');
        
        ws.onopen = function() {
            addMessage(-1, 'Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°', 'ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ');
        };
        
        ws.onclose = function() {
            addMessage(-1, 'Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°', 'Ð¡Ð¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¾');
        };
        
        ws.onmessage = function(event) {
            event = JSON.parse(event.data);
            // alert(event.event_type + " " + event.data);
            // Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð° switch
            if (event.event_type == "message") {
                const msg = JSON.parse(event.data);
                if (msg.filename != "") {
                    addFile(msg.chat_id, msg.sender.username, msg.filename);
                }
                else {
                    addMessage(msg.chat_id, msg.sender.username, msg.message);
                }
            }
            else if (event.event_type == "uid") {
                my_uid = JSON.parse(event.data);
                document.getElementById('my_uid').innerText = "Ð’Ð°Ñˆ ID: " + my_uid;
            }
            else if (event.event_type == "invitation") {
                const chat_id = parseInt(event.data);
                addChat(chat_id);
            }
            else if (event.event_type == "file") {
                const a = document.createElement('a');
                data = JSON.parse(event.data);
                a.href = data.content;
                a.download = data.filename;
                a.click();
            }
            else if (event.event_type == "addition") {
                data = JSON.parse(event.data);
                addUser(data.chat_id, data.user_id, data.username, data.is_admin);
            }
            else if (event.event_type == "toggle_user_info") {
                data = JSON.parse(event.data);
                users_element = chats.children[chats_map[data.chat_id]].children[1];

                if (data.is_admin) {
                    is_admin_now = chats_users_map[data.chat_id][data.user_id].is_admin;
                    chats_users_map[data.chat_id][data.user_id].is_admin = !is_admin_now;
                    
                    if (is_admin_now) {
                        users_element.children[chats_users_map[data.chat_id][data.user_id].position].children[0].innerText = "";
                    }
                    else {
                        users_element.children[chats_users_map[data.chat_id][data.user_id].position].children[0].innerText = "(Admin)";
                    }
                }

                if (data.is_muted) {
                    is_muted_now = chats_users_map[data.chat_id][data.user_id].is_muted;
                    chats_users_map[data.chat_id][data.user_id].is_muted = !is_muted_now;
                    
                    if (is_muted_now) {
                        users_element.children[chats_users_map[data.chat_id][data.user_id].position].children[1].innerText = "";
                    }
                    else {
                        users_element.children[chats_users_map[data.chat_id][data.user_id].position].children[1].innerText = "(Muted)";
                    }
                }

                if (data.is_kicked) {                    
                    // FIXME: perform the actual deletion
                    users_element.children[chats_users_map[data.chat_id][data.user_id].position].innerHTML = "";

                    // FIXME: perform the actual deletion
                    if (data.user_id == my_uid) {
                        chats.children[chats_map[data.chat_id]].innerHTML = "";
                    }
                }
            }
        };
        
        function sendMessage(chat_id, messageInput, fileInput) {
            const message = messageInput.value;
            const flies = fileInput.flies;
            
            if (message) {
                ws.send(JSON.stringify({
                    event_type: "message",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        message: message,
                        sender: {
                            uid: my_uid,
                            username: my_username,
                        },
                        chat_id: chat_id,
                        filename: "",
                    })
                }));
                messageInput.value = '';
            }

            for (const file of fileInput.files) {
                let name = file.name;

                let reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onload = function() {
                    console.log(reader.result);
                    ws.send(JSON.stringify({
                        event_type: "message",
                        sender_uid: my_uid,
                        data: JSON.stringify({
                            message: reader.result,
                            sender: {
                                uid: my_uid,
                                username: my_username,
                            },
                            chat_id: chat_id,
                            filename: name,
                        })
                    }));
                };

                reader.onerror = function() {
                    console.log(reader.error);
                };
            }

            if (fileInput.files.length) {
                fileInput.value = '';
            }
        }

        function addChat(chat_id, can_send_messages=true) {
            const chat_index = Object.keys(chats_map).length;
            chats_map[chat_id] = chat_index;
            chats_users_map[chat_id] = {};
            chats.appendChild(document.createElement('div'));

            const chatElement = document.createElement('div');
            chatElement.className = 'chat';
            chats.lastElementChild.appendChild(chatElement);

            const usersElement = document.createElement('div');
            usersElement.className = 'users';
            chats.lastElementChild.appendChild(usersElement);

            const chatIdElement = document.createElement('div');
            chatIdElement.innerText = "ID Ñ‡Ð°Ñ‚Ð°: " + chat_id;
            chats.lastElementChild.appendChild(chatIdElement);

            if (!can_send_messages) return;

            const inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.style ='width: 300px;';
            inputElement.placeholder = 'Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ';
            
            

            const fileElement = document.createElement('input');
            fileElement.type = 'file';
            fileElement.style ='width: 100px;';
            fileElement.placeholder = 'Ð¤Ð°Ð¹Ð»';
            // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¿Ð¾ Enter
            inputElement.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage(chat_id, inputElement, fileElement);
                }
            });
            // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¿Ð¾ Enter
            fileElement.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage(chat_id, inputElement, fileElement);
                }
            });
            chats.lastElementChild.appendChild(inputElement);
            chats.lastElementChild.appendChild(fileElement);

            const buttonElement = document.createElement('button');
            buttonElement.innerText = 'ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ';
            buttonElement.onclick = () => sendMessage(chat_id, chats.lastElementChild.lastElementChild,
                chats.lastElementChild.children[chats.lastElementChild.children.length - 2]
            ); // Ð¡Ð¾Ð¼Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚
            chats.lastElementChild.appendChild(buttonElement);
        }

        function addUser(chat_id, user_id, username, is_admin) {
            chats_users_map[chat_id][user_id] = {
                "username": username,
                "is_admin": is_admin,
                "is_muted": false,
                "position": Object.keys(chats_users_map[chat_id]).length,
            };

            const userElement = document.createElement('div');
            userElement.innerText = "" + user_id + ": " + username;

            const isAdmin = document.createElement('div');
            if (is_admin) isAdmin.innerText = '(Admin)';
            userElement.appendChild(isAdmin);

            const isMuted = document.createElement('div');
            userElement.appendChild(isMuted);
            
            kickButton = document.createElement('button');
            muteButton = document.createElement('button');
            addAdminButton = document.createElement('button');

            kickButton.innerText = 'ðŸ‘Ÿ';
            muteButton.innerText = 'ðŸ”‡';
            addAdminButton.innerText = 'ðŸ‘‘';

            kickButton.onclick = () => {
                ws.send(JSON.stringify({
                    event_type: "toggle_user_info",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        user_id: user_id,
                        chat_id: chat_id,
                        is_admin: false,
                        is_muted: false,
                        is_kicked: true,
                    })
                }));
            }

            muteButton.onclick = () => {
                ws.send(JSON.stringify({
                    event_type: "toggle_user_info",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        user_id: user_id,
                        chat_id: chat_id,
                        is_admin: false,
                        is_muted: true,
                        is_kicked: false,
                    })
                }));
            }

            addAdminButton.onclick = () => {
                ws.send(JSON.stringify({
                    event_type: "toggle_user_info",
                    sender_uid: my_uid,
                    data: JSON.stringify({
                        user_id: user_id,
                        chat_id: chat_id,
                        is_admin: true,
                        is_muted: false,
                        is_kicked: false,
                    })
                }));
            }

            userElement.appendChild(kickButton);
            userElement.appendChild(muteButton);
            userElement.appendChild(addAdminButton);

            let usersElement = chats.children[chats_map[chat_id]].children[1];
            usersElement.appendChild(userElement);
            usersElement.scrollTop = usersElement.scrollHeight;
        }
        
        function addMessage(chat_id, username, message, time = new Date().toLocaleTimeString()) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
                <span class="username">${username}:</span>
                ${message}
            `;
            let chat = chats.children[chats_map[chat_id]].children[0];
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }

        function sendAddChat() {
            const chatIdElement = document.getElementById("new_chat_id");
            const chatUidElement = document.getElementById("new_chat_uid");

            new_chat_id = chatIdElement.value;
            if (new_chat_id == "") new_chat_id = "-1";
            new_chat_uid = chatUidElement.value;

            ws.send(JSON.stringify({
                event_type: "invitation",
                sender_uid: my_uid,
                data: JSON.stringify({
                    chat_id: parseInt(new_chat_id),
                    user_id: parseInt(new_chat_uid),
                }),
            }));

            chatIdElement.value = "";
            chatUidElement.value = "";
        }

        function addFile(chat_id, username, filename) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
                <span class="username">${username}:</span>
            `;
            const buttonElement = document.createElement('button');
            buttonElement.innerText = filename;
            buttonElement.onclick = () => {
                ws.send(JSON.stringify({
                    event_type: "file",
                    sender_uid: my_uid,
                    data: filename,
                }));
            }
            messageElement.appendChild(buttonElement);
            let chat = chats.children[chats_map[chat_id]].children[0];
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }

        document.getElementById("new_chat_uid").addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAddChat();
            }
        });

        document.getElementById("new_chat_id").addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAddChat();
            }
        });
    </script>
</body>
</html>